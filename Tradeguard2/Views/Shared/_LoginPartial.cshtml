@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Tradeguard2.Data
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext ApplicationDbContext

<ul class="navbar-nav">
    @if (SignInManager.IsSignedIn(User))
    {

             <li id="Item_conjunto" class="nav-item dropdown ms-0">
                <!-- Adicione a classe ms-0 aqui -->
                <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Perfil
                </a>
                <ul id="conjunto_li2" class="dropdown-menu">
                    <li>
                        <a class="dropdown-item" asp-action="DetailsUser" asp-controller="User">
                            Dados Pessoais
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person" viewBox="0 0 16 16">
                                <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4Zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10Z" />
                            </svg>
                        </a>
                    </li>

                    <li>
                        <a class="dropdown-item" asp-action="Index" asp-controller="Denuncias">
                            Histórico de Denúncias
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-emoji-angry" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                <path d="M4.285 12.433a.5.5 0 0 0 .683-.183A3.498 3.498 0 0 1 8 10.5c1.295 0 2.426.703 3.032 1.75a.5.5 0 0 0 .866-.5A4.498 4.498 0 0 0 8 9.5a4.5 4.5 0 0 0-3.898 2.25.5.5 0 0 0 .183.683zm6.991-8.38a.5.5 0 1 1 .448.894l-1.009.504c.176.27.285.64.285 1.049 0 .828-.448 1.5-1 1.5s-1-.672-1-1.5c0-.247.04-.48.11-.686a.502.502 0 0 1 .166-.761l2-1zm-6.552 0a.5.5 0 0 0-.448.894l1.009.504A1.94 1.94 0 0 0 5 6.5C5 7.328 5.448 8 6 8s1-.672 1-1.5c0-.247-.04-.48-.11-.686a.502.502 0 0 0-.166-.761l-2-1z" />
                            </svg>
                        </a>
                    </li>
                    <li>
                    <a class="dropdown-item" asp-action="Index" asp-controller="Avaliacaos">
                            Histórico de Avaliação
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16">
                                <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.565.565 0 0 0-.163-.505L1.71 6.745l4.052-.576a.525.525 0 0 0 .393-.288L8 2.223l1.847 3.658a.525.525 0 0 0 .393.288l4.052.575-2.906 2.77a.565.565 0 0 0-.163.506l.694 3.957-3.686-1.894a.503.503 0 0 0-.461 0z" />
                            </svg>
                        </a>
                    </li>

                <li>
                    <a class="dropdown-item" asp-action="VeerPublicador" asp-controller="PropostasDeCompras">
                        Meus Anúncios
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-badge-ad" viewBox="0 0 16 16">
                            <path d="m3.7 11 .47-1.542h2.004L6.644 11h1.261L5.901 5.001H4.513L2.5 11zm1.503-4.852.734 2.426H4.416l.734-2.426zm4.759.128c-1.059 0-1.753.765-1.753 2.043v.695c0 1.279.685 2.043 1.74 2.043.677 0 1.222-.33 1.367-.804h.057V11h1.138V4.685h-1.16v2.36h-.053c-.18-.475-.68-.77-1.336-.77zm.387.923c.58 0 1.002.44 1.002 1.138v.602c0 .76-.396 1.2-.984 1.2-.598 0-.972-.449-.972-1.248v-.453c0-.795.37-1.24.954-1.24z" />
                            <path d="M14 3a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zM2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z" />
                        </svg>
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-action="Index" asp-controller="PropostasDeCompras">
                        Minhas Propostas
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down-up" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M11.5 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L11 2.707V14.5a.5.5 0 0 0 .5.5m-7-14a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L4 13.293V1.5a.5.5 0 0 1 .5-.5" />
                        </svg>
                        @{
                            var user = await UserManager.GetUserAsync(User);
                            if (user != null)
                            {
                                var countPropostasNaoVistas = ApplicationDbContext.PropostasDeCompra
                                .Where(p => p.CC_vendedor == user.CC && !p.Proposta_Aceite )
                                .Count();
                                ViewData["CountPropostasNaoVistas"] = countPropostasNaoVistas;
                            }
                        }
                        @if (Convert.ToInt32(ViewData["CountPropostasNaoVistas"]) > 0)
                        {
                            <span class="unread-count bolinha-azul">@ViewData["CountPropostasNaoVistas"]</span>
                        }
                    </a>
                </li>

                <li>
                    <a class="dropdown-item" asp-action="IndexPorEnviar" asp-controller="PropostasDeCompras">
                        Anúncios por Enviar
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z" />
                        </svg>
                       
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-action="ValidarEncomenda" asp-controller="PropostasDeCompras">
                        Anúncios para Validar

                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash" viewBox="0 0 16 16">
                            <path d="M8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4" />
                            <path d="M0 4a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V6a2 2 0 0 1-2-2z" />
                        </svg>

                        @{
                            var userLoginId = await UserManager.GetUserAsync(User);
                            if (userLoginId != null)
                            {
                              

                                var anuncios = await ApplicationDbContext.Anuncios
                                .Where(a => a.UserId != userLoginId.Id)
                                .ToListAsync();

                                var propostaAnuncio = await ApplicationDbContext.PropostasDeCompra
                                .Where(a => a.CC_comprador == userLoginId.CC && a.Proposta_Aceite == true && a.Produto_recebido == false)
                                .ToListAsync();

                                var resultado = anuncios
                                .Join(propostaAnuncio,
                                anuncio => anuncio.Id_anuncio,
                                proposta => proposta.Id_Anuncio,
                                (anuncio, proposta) => new PropostaAnuncioViewModel
                            {
                                Proposta = proposta,
                                Anuncio = anuncio
                            })
                                .ToList().Count();


                                ViewData["countPropostasNaoValidada"] = resultado;
                            }
                        }
                        @if (Convert.ToInt32(ViewData["countPropostasNaoValidada"]) > 0)
                        {
                            <span class="unread-count bolinha-azul">@ViewData["countPropostasNaoValidada"]</span>
                        }
                    </a>
                </li>
                    <li>
                        <a class="dropdown-item" asp-action="Gerir_Carteira" asp-controller="User">
                            Gerir Carteira
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-wallet" viewBox="0 0 16 16">
                                <path d="M0 3a2 2 0 0 1 2-2h13.5a.5.5 0 0 1 0 1H15v2a1 1 0 0 1 1 1v8.5a1.5 1.5 0 0 1-1.5 1.5h-12A2.5 2.5 0 0 1 0 12.5V3zm1 1.732V12.5A1.5 1.5 0 0 0 2.5 14h12a.5.5 0 0 0 .5-.5V5H2a1.99 1.99 0 0 1-1-.268zM1 3a1 1 0 0 0 1 1h12V2H2a1 1 0 0 0-1 1z" />
                            </svg>
                        </a>
                    </li>
                    <li>
                        <form class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Page("/", new { area = "" })" method="post">

                            <button type="submit" class="dropdown-item">
                                Terminar Sessão
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-left" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z" />
                                    <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z" />
                                </svg>

                            </button>
                        </form>
                    </li>



                </ul>

            </li>

        <li id="Item_conjunto2" class="nav-item ms-0">
            <!-- Adicione a classe ms-0 aqui -->
            <button style="margin-left:20px;"class="anunciar_vender anunciar-vender-button">
                <a class="nav-link active" asp-action="Create" asp-controller="Anuncios">
                    Anunciar e Vender
                </a>
            </button>
        </li>
    }
    else
    {
        <li id="Item_conjunto2" style="margin-left:0px;" class="nav-item">
            <button  class="anunciar_vender anunciar-vender-button">
                <a class="nav-link active" asp-area="Identity" asp-page="/Account/Login">
                    Iniciar Sessão
                </a>
            </button>

        </li>
    }
</ul>
